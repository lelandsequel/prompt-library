name: PromptOS Evaluation

# [![PromptOS CI](https://github.com/yourepo/prompt-library/actions/workflows/prompts.yml/badge.svg)](https://github.com/yourepo/prompt-library/actions/workflows/prompts.yml)

on:
  push:
    branches: [main, master]
    paths:
      - 'promptos/**'
  pull_request:
    branches: [main, master]
    paths:
      - 'promptos/**'

jobs:
  evaluate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install eval dependencies
        run: |
          cd promptos/eval
          npm install

      - name: Install root dependencies
        run: |
          cd promptos
          npm install --no-save js-yaml yaml 2>/dev/null || true

      - name: Detect changed prompts
        id: changes
        run: |
          # Detect changed files in promptos/
          CHANGED=$(git diff --name-only origin/main HEAD -- promptos/ 2>/dev/null || git diff --name-only HEAD~1 HEAD -- promptos/ 2>/dev/null || echo "")
          echo "Changed files:"
          echo "$CHANGED"

          # Check if core files changed (force full run)
          CORE_CHANGED=$(echo "$CHANGED" | grep -E "promptos/(policy|rbac|runtime|eval/ci-runner)" || true)

          if [ -n "$CORE_CHANGED" ]; then
            echo "Core files changed — running full suite"
            echo "FULL_RUN=true" >> $GITHUB_ENV
            echo "CHANGED_PROMPTS=" >> $GITHUB_ENV
          else
            # Extract changed prompt IDs from YAML filenames
            CHANGED_IDS=$(echo "$CHANGED" | grep "promptos/prompts/" | grep -E "\.(yaml|yml)$" | xargs -I{} basename {} | sed 's/\.yaml$//' | sed 's/\.yml$//' | tr '\n' ',' | sed 's/,$//')
            echo "Changed prompt IDs: $CHANGED_IDS"
            echo "FULL_RUN=false" >> $GITHUB_ENV
            echo "CHANGED_PROMPTS=$CHANGED_IDS" >> $GITHUB_ENV
          fi

      - name: Validate changed prompts
        run: |
          cd promptos
          # Install js-yaml for policy engine
          npm install --no-save js-yaml 2>/dev/null || true
          if [ "${FULL_RUN}" = "true" ]; then
            echo "Validating all prompts..."
            node cli/index.js validate || true
          elif [ -n "${CHANGED_PROMPTS}" ]; then
            echo "Validating changed prompts: ${CHANGED_PROMPTS}"
            IFS=',' read -ra IDS <<< "${CHANGED_PROMPTS}"
            for id in "${IDS[@]}"; do
              echo "Validating: $id"
              node cli/index.js validate "$id" || true
            done
          else
            echo "No prompt changes detected, skipping validation"
          fi

      - name: Run evaluation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LLM_MODEL: ${{ vars.LLM_MODEL || 'claude-sonnet-4-20250514' }}
          CHANGED_PROMPTS: ${{ env.CHANGED_PROMPTS }}
          FULL_RUN: ${{ env.FULL_RUN }}
        run: |
          cd promptos/eval
          if [ "${FULL_RUN}" = "true" ] || [ -z "${CHANGED_PROMPTS}" ]; then
            echo "Running full evaluation suite..."
            node ci-runner.js --output=test-results.xml || echo "Eval completed (some tests may have failed)"
          else
            echo "Running changed-only evaluation for: ${CHANGED_PROMPTS}"
            node ci-runner.js --output=test-results.xml --changed-only || echo "Eval completed"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: promptos/eval/test-results.xml

      - name: Check for failures
        run: |
          if [ -f promptos/eval/test-results.xml ]; then
            FAILURES=$(grep -o 'failures="[0-9]*"' promptos/eval/test-results.xml | grep -o '[0-9]*' || echo "0")
            if [ "$FAILURES" -gt "0" ] 2>/dev/null; then
              echo "::error::Evaluation failed — $FAILURES test(s) did not pass"
              exit 1
            else
              echo "All evaluations passed!"
            fi
          else
            echo "No test results file found"
          fi
